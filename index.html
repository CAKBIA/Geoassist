<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Esri GIS Technical Support</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Tailwind config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            esriBlue: '#005995',
            esriLightBlue: '#e9f1f7',
            esriGray: '#f8f8f8',
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
        },
      },
    };
  </script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap");

    body {
      font-family: 'Inter', sans-serif;
    }

    /* Loading dots animation */
    .animate-pulse-dot {
      animation: pulse-dot 1.4s infinite ease-in-out both;
    }
    .animate-pulse-dot:nth-child(1) { animation-delay: -0.32s; }
    .animate-pulse-dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes pulse-dot {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* Scrollbar styling */
    .chat-scroll-container {
      max-height: 70vh;
      overflow-y: auto;
    }
    .chat-scroll-container::-webkit-scrollbar { width: 8px; }
    .chat-scroll-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .chat-scroll-container::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
    .chat-scroll-container::-webkit-scrollbar-thumb:hover { background: #555; }

    /* Markdown styling */
    .markdown-content ul { list-style-type: disc; margin-left: 1.2rem; margin-bottom: 0.5rem; }
    .markdown-content ol { list-style-type: decimal; margin-left: 1.2rem; margin-bottom: 0.5rem; }
    .markdown-content strong { font-weight: 600; }
    .markdown-content h1, .markdown-content h2, .markdown-content h3 { margin-top: 1rem; margin-bottom: 0.5rem; }
    .markdown-content a { color: #005995; text-decoration: underline; }
    .markdown-content pre { background-color: #e2e8f0; padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; }
  </style>
</head>

<body class="bg-gray-100 font-sans flex items-center justify-center min-h-screen p-4">
  <div id="root" class="w-full max-w-2xl h-[90vh] flex flex-col"></div>

  <!-- React, ReactDOM, Marked, and DOMPurify (Production Builds) -->
  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" defer></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/lib/marked.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.25.6/babel.min.js" defer></script>

  <script type="text/babel">
    // Check for dependencies
    window.addEventListener('load', () => {
      if (typeof marked === 'undefined') {
        console.error('Marked.js failed to load. Falling back to plain text.');
      }
      if (typeof DOMPurify === 'undefined') {
        console.error('DOMPurify failed to load. Markdown sanitization disabled.');
      }
    });

    const App = () => {
      const [messages, setMessages] = React.useState([]);
      const [input, setInput] = React.useState('');
      const [isLoading, setIsLoading] = React.useState(false);
      const [showConfirmModal, setShowConfirmModal] = React.useState(false);
      const messagesEndRef = React.useRef(null);
      const inputRef = React.useRef(null);
      const apiKey = "AIzaSyADvIoS1NcspmkXp3sHYrD38zhh1DlBXAM"; // Replace with your Google API key
      const cx = "25ed03fb10e654c08"; // Replace with your Google CSE ID
      const model = "gemini-1.5-pro";

      // Load stored messages
      React.useEffect(() => {
        try {
          const storedMessages = JSON.parse(localStorage.getItem('esriChatMessages') || '[]');
          setMessages(storedMessages.length > 0 ? storedMessages : [
            { text: 'Hello! I\'m Geo-Assist, your Esri GIS helper. Ask about GIS tools, troubleshooting, or use cases!', sender: 'bot' }
          ]);
        } catch (e) {
          console.error('Failed to load messages from localStorage:', e);
        }
      }, []);

      // Scroll to latest message
      React.useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      // Focus input
      React.useEffect(() => {
        if (!isLoading && inputRef.current) {
          inputRef.current.focus();
        }
      }, [isLoading]);

      // Persist messages
      React.useEffect(() => {
        try {
          localStorage.setItem('esriChatMessages', JSON.stringify(messages));
        } catch (e) {
          console.error('Failed to save messages to localStorage:', e);
        }
      }, [messages]);

      // Modular Knowledge Base
      const esriKnowledgeBase = {
        whatIsGis: `
### 1. What is GIS?
- **Definition**: A Geographic Information System (GIS) captures, stores, manages, analyzes, and visualizes spatial data.
- **Components**: Spatial data, software (e.g., ArcGIS Pro), hardware, people, methods (e.g., buffering).
- **Examples**: Flood zone mapping, traffic analysis, urban planning.
- **Source**: Esri Documentation (https://www.esri.com/en-us/what-is-gis/overview).
        `.trim(),
        gisApplications: `
### 2. GIS Applications
- **Urban Planning**: Zoning analysis, transportation planning, dashboards.
- **Environmental**: Wildlife mapping, climate analysis.
- **Business**: Site selection, market analysis.
- **Source**: Esri Solutions (https://www.esri.com/en-us/industries).
        `.trim(),
        mineralExploration: `
### 23. ArcGIS for Mineral Exploration
- **Overview**: Analyze geological data for drilling locations.
- **Tools**: ArcGIS Pro (Spatial Analyst, 3D Analyst), ArcGIS Online, Field Maps.
- **Workflow**:
  1. Import geological data.
  2. Use Weighted Overlay for site ranking.
  3. Visualize in 3D or web maps.
  4. Deploy Field Maps.
- **Example**: Map gold deposits in Nevada.
- **Source**: Esri Mining (https://www.esri.com/en-us/industries/mining).
        `.trim(),
        advancedGeoprocessing: `
### 24. Advanced Geoprocessing
- **Tools**: Overlay (Union, Intersect), Proximity (Buffer), Spatial Analyst (raster).
- **Use Case**: Combine datasets for suitability analysis (e.g., land use planning).
- **Troubleshooting**: Check licensing, coordinate systems, geometry validity.
- **Source**: ArcGIS Pro Docs (https://pro.arcgis.com/en/pro-app/latest/tool-reference).
        `.trim()
      };

      const getRelevantKB = (query) => {
        if (query.toLowerCase().includes('what is gis')) return esriKnowledgeBase.whatIsGis;
        if (query.toLowerCase().includes('use cases') || query.toLowerCase().includes('how can')) return esriKnowledgeBase.gisApplications;
        if (query.toLowerCase().includes('mining') || query.toLowerCase().includes('mineral exploration')) return esriKnowledgeBase.mineralExploration;
        if (query.toLowerCase().includes('geoprocessing') || query.toLowerCase().includes('spatial analysis')) return esriKnowledgeBase.advancedGeoprocessing;
        return Object.values(esriKnowledgeBase).join('\n\n');
      };

      const sendMessage = async (e) => {
        e.preventDefault();
        if (input.trim() === '' || isLoading) return;

        const userInput = input.trim();
        setMessages((curr) => [...curr, { text: userInput, sender: 'user' }]);
        setInput('');
        setIsLoading(true);

        let botText = '';

        const fetchServiceMetadata = async (url) => {
          try {
            if (!url.includes('arcgis') || !url.match(/\/rest\/services\/[^/]+\/(MapServer|FeatureServer)/)) {
              return 'Please provide a valid ArcGIS REST service URL.';
            }
            const response = await fetch(`${url}?f=json`, { signal: AbortSignal.timeout(5000) });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return `**Service Metadata**: ${data.name || 'Untitled'}\n- Description: ${data.description || 'N/A'}\n- Layers: ${data.layers?.map(l => l.name).join(', ') || 'N/A'}`;
          } catch (error) {
            return `Failed to fetch metadata: ${error.message}`;
          }
        };

        const fetchEsriSearchResults = async (query) => {
          const cacheKey = `esri_search_${query}`;
          const cached = localStorage.getItem(cacheKey);
          if (cached) return cached;
          try {
            const searchUrl = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${cx}&q=${encodeURIComponent(query + ' site:*.esri.com')}&num=5`;
            const response = await fetch(searchUrl);
            if (!response.ok) throw new Error(`Search API error: ${response.status}`);
            const data = await response.json();
            const result = data.items?.map(item => `- **${item.title}**: ${item.snippet} ([Source](${item.link}))`).join('\n') || 'No search results.';
            localStorage.setItem(cacheKey, result);
            setTimeout(() => localStorage.removeItem(cacheKey), 30 * 24 * 60 * 60 * 1000);
            return result;
          } catch (error) {
            return `Search failed: ${error.message}`;
          }
        };

        let lastRequestTime = 0;
        const minRequestInterval = 1000;
        const callApiWithBackoff = async (apiCall, retries = 3, delay = 1000) => {
          const now = Date.now();
          if (now - lastRequestTime < minRequestInterval) {
            await new Promise(res => setTimeout(res, minRequestInterval - (now - lastRequestTime)));
          }
          lastRequestTime = now;
          try {
            return await apiCall();
          } catch (error) {
            if (retries > 0 && (error.message.includes('429') || error.message.includes('timeout'))) {
              await new Promise(res => setTimeout(res, delay));
              return callApiWithBackoff(apiCall, retries - 1, delay * 2);
            }
            throw error;
          }
        };

        if (userInput.match(/https?:\/\//)) {
          const urlMatch = userInput.match(/https?:\/\/[^\s]+/);
          botText = urlMatch ? await fetchServiceMetadata(urlMatch[0]) : 'Please provide a valid ArcGIS service URL.';
          setMessages((curr) => [...curr, { text: botText, sender: 'bot' }]);
          setIsLoading(false);
          return;
        }

        try {
          const isExploratory = userInput.toLowerCase().includes('ideas') || userInput.toLowerCase().includes('use cases') || userInput.toLowerCase().includes('how can');
          const searchResults = userInput.toLowerCase().includes('what is gis') ? '' : await fetchEsriSearchResults(userInput);
          const systemInstruction = {
            role: "system",
            parts: [{
              text: `You are Geo-Assist, a technical support assistant for Esri GIS products. Provide accurate, structured responses with headings, bullets, examples, and sources. Prioritize the knowledge base for basic questions, supplement with search results for advanced queries. Cite sources inline. Do not mention AI.
Knowledge Base: ${getRelevantKB(userInput)}
Search Results: ${searchResults}`
            }]
          };
          const chatHistory = messages.slice(-3).map(msg => ({
            role: msg.sender === 'user' ? 'user' : 'model',
            parts: [{ text: msg.text }]
          }));
          chatHistory.push({ role: "user", parts: [{ text: userInput }] });
          const payload = {
            contents: chatHistory,
            systemInstruction,
            generationConfig: { maxOutputTokens: isExploratory ? 4000 : 1000 }
          };
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
          const apiCall = async () => {
            const response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
              signal: AbortSignal.timeout(8000)
            });
            if (!response.ok) throw new Error(`API error: ${response.status}`);
            const result = await response.json();
            if (result.candidates?.[0]?.finishReason === 'MAX_TOKENS') {
              return result.candidates[0].content.parts[0].text + '\n\n**Warning**: Response truncated. Try a more specific query.';
            }
            return result.candidates?.[0]?.content?.parts?.[0]?.text || 'No valid response from API.';
          };
          botText = await callApiWithBackoff(apiCall);
        } catch (error) {
          console.error('API error:', error);
          botText = `Failed to retrieve response: ${error.message}. Fallback: ${getRelevantKB(userInput)}`;
        }
        setMessages((curr) => [...curr, { text: botText, sender: 'bot' }]);
        setIsLoading(false);
      };

      const BotMessage = React.memo(({ message }) => (
        <div className="flex items-start mb-4">
          <div className="flex-shrink-0 w-8 h-8 rounded-full bg-esriBlue flex items-center justify-center text-white font-bold text-sm mr-2">
            GA
          </div>
          <div className="bg-esriLightBlue p-3 rounded-xl shadow-sm max-w-lg">
            <div
              className="text-gray-900 leading-relaxed markdown-content"
              dangerouslySetInnerHTML={{ __html: typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(marked.parse(message.text)) : message.text }}
            />
          </div>
        </div>
      ));

      const UserMessage = React.memo(({ message }) => (
        <div className="flex items-end justify-end mb-4">
          <div className="bg-esriBlue text-white p-3 rounded-xl shadow-sm max-w-lg">
            <p className="leading-relaxed">{message.text}</p>
          </div>
        </div>
      ));

      const ConfirmModal = () => (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto">
            <h3 className="text-lg font-semibold mb-4">Clear Chat History</h3>
            <p className="mb-6">Are you sure you want to clear the chat history?</p>
            <div className="flex justify-end space-x-2">
              <button
                onClick={() => setShowConfirmModal(false)}
                className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300"
              >
                Cancel
              </button>
              <button
                onClick={() => {
                  setMessages([]);
                  localStorage.removeItem('esriChatMessages');
                  setShowConfirmModal(false);
                }}
                className="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700"
              >
                Clear
              </button>
            </div>
          </div>
        </div>
      );

      return (
        <div className="bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col h-full border border-gray-200">
          <div className="bg-esriBlue text-white p-4 flex items-center justify-between rounded-t-xl shadow-md">
            <div className="flex items-center">
              <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center mr-3">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6 text-esriBlue" aria-label="Geo-Assist Logo">
                  <path d="M7.749 1.576a.77.77 0 0 0-.251.725l1.58 4.743a.77.77 0 0 0 .903.543l3.411-.99a.77.77 0 0 1 .588.163l4.777 4.778a.77.77 0 0 1 .163.587l-.99 3.412a.77.77 0 0 0 .543.903l4.743 1.581c.29.097.436.417.252.724a.77.77 0 0 1-.725.252l-4.743-1.58a.77.77 0 0 0-.903.543l-.99 3.411a.77.77 0 0 1-.163.588l-4.778 4.777a.77.77 0 0 1-.587.163l-3.412-.99a.77.77 0 0 0-.903.543l-1.581 4.743a.77.77 0 0 1-.724.251a.77.77 0 0 1-.252-.725l1.58-4.743a.77.77 0 0 0-.543-.903l-3.411-.99a.77.77 0 0 1-.588-.163l-4.777-4.778a.77.77 0 0 1-.163-.587l.99-3.412a.77.77 0 0 0-.543-.903L.027 2.39a.77.77 0 0 1 .724-.251Z" />
                </svg>
              </div>
              <h1 className="text-xl font-bold">Geo-Assist</h1>
            </div>
            <button
              onClick={() => setShowConfirmModal(true)}
              className="flex items-center text-sm text-gray-200 hover:text-white"
              aria-label="Clear Chat"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5 mr-1" aria-label="Clear Chat Icon">
                <path d="M5.755 5.948A4.755 4.755 0 0 1 10.5 1.25h3c.895 0 1.746.356 2.378.988A4.755 4.755 0 0 1 18.75 5.948v.552h-2.127l-.61-1.832a.75.75 0 0 0-.585-.453l-6.876-1.588c-.378-.087-.736.1-.908.435-.172.335-.078.723.228.985l.628.532H4.25a.75.75 0 0 0 0 1.5h15.5a.75.75 0 0 0 0-1.5H4.25v-.552Z" />
                <path fillRule="evenodd" d="M3.75 6.75a.75.75 0 0 0-.75.75V19.5c0 1.144.863 2.054 1.996 2.054h14.008c1.133 0 1.996-.91 1.996-2.054V7.5a.75.75 0 0 0-.75-.75H3.75ZM6 12a.75.75 0 0 1 .75-.75h2a.75.75 0 0 1 0 1.5h-2A.75.75 0 0 1 6 12Zm3.5 1.5a.75.75 0 0 0 0 1.5h3.75a.75.75 0 0 0 0-1.5H9.5ZM12 10.5h-2a.75.75 0 0 0 0 1.5h2a.75.75 0 0 0 0-1.5Z" clipRule="evenodd" />
              </svg>
              <span>Clear Chat</span>
            </button>
          </div>
          <div className="flex-1 chat-scroll-container p-4">
            {messages.map((msg, index) => (
              msg.sender === 'user' ? (
                <UserMessage key={index} message={msg} />
              ) : (
                <BotMessage key={index} message={msg} />
              )
            ))}
            <div ref={messagesEndRef} />
            {isLoading && (
              <div className="flex items-start mb-4">
                <div className="flex-shrink-0 w-8 h-8 rounded-full bg-esriBlue flex items-center justify-center text-white font-bold text-sm mr-2">
                  GA
                </div>
                <div className="flex items-center space-x-2 bg-esriLightBlue p-3 rounded-xl shadow-sm">
                  <span className="h-2 w-2 rounded-full bg-esriBlue animate-pulse-dot"></span>
                  <span className="h-2 w-2 rounded-full bg-esriBlue animate-pulse-dot"></span>
                  <span className="h-2 w-2 rounded-full bg-esriBlue animate-pulse-dot"></span>
                </div>
              </div>
            )}
          </div>
          <div className="p-4 border-t border-gray-200">
            <form onSubmit={sendMessage} className="flex space-x-2">
              <input
                ref={inputRef}
                type="text"
                className="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-esriBlue"
                value={input}
                onChange={(e) => setInput(e.target.value)}
                placeholder="Ask a question about Esri GIS..."
                disabled={isLoading}
              />
              <button
                type="submit"
                className={`py-2 px-4 rounded-lg text-white font-semibold ${isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-esriBlue hover:bg-opacity-90'}`}
                disabled={isLoading}
              >
                Send
              </button>
            </form>
          </div>
          {showConfirmModal && <ConfirmModal />}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
